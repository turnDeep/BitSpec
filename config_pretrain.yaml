# config_pretrain.yaml
# NEIMS v2.0 Teacher事前学習設定ファイル
# Phase 1: PCQM4Mv2事前学習（Bond Masking）

# プロジェクト設定
project:
  name: "NEIMS_v2_Teacher_Pretrain"
  description: "Teacher GNN+ECFP Pretraining on PCQM4Mv2"
  version: "2.0.0"

# データ設定
data:
  # PCQM4Mv2事前学習データ
  pcqm4mv2_path: "data/pcqm4mv2"
  auto_download: true           # 自動ダウンロード

  # NIST EI-MSデータ（ファインチューニング用）
  nist_msp_path: "data/NIST17.msp"
  mol_files_dir: "data/mol_files"

  # 処理済みデータ
  output_dir: "data/processed"

  # データ分割
  train_split: 0.8
  val_split: 0.1
  test_split: 0.1

  # スペクトル設定
  max_mz: 500                   # NEIMS v2.0: m/z 0-500
  mz_bin_size: 1.0
  min_intensity: 0.001

# Teacher Model設定（GNN + ECFP Hybrid）
model:
  # Teacher Model
  teacher:
    type: "GNN_ECFP_Hybrid"

    # GNN Branch
    gnn:
      conv_type: "GINEConv"       # Edge features対応
      num_layers: 8               # Deep GNN
      hidden_dim: 256
      edge_dim: 128
      dropout: 0.3                # MC Dropout用
      drop_edge: 0.2              # Over-smoothing防止
      use_pair_norm: true         # PairNorm正規化
      use_bond_breaking: true     # Bond-Breaking Attention

    # ECFP Branch
    ecfp:
      fingerprint_size: 4096      # ECFP4
      mlp_hidden: 1024
      mlp_output: 512
      dropout: 0.3

    # Fusion
    fusion_dim: 1280              # GNN(768) + ECFP(512)

    # Prediction Head
    prediction:
      hidden_dims: [1024, 512]
      output_dim: 501             # m/z 0-500
      use_bidirectional: true     # NEIMS-style

    # MC Dropout（ファインチューニング時）
    mc_dropout:
      n_samples: 30
      dropout_rate: 0.3

  # 共通設定
  common:
    node_features: 48           # Atom features
    edge_features: 6            # Bond features
    spectrum_dim: 501

# 訓練設定
training:
  # Phase 1: Teacher事前学習（PCQM4Mv2）
  teacher_pretrain:
    # データセット設定
    dataset: "PCQM4Mv2"
    data_path: "data/pcqm4mv2"
    task: "bond_masking"          # Self-supervised task

    # 訓練設定（RTX 5070 Ti 16GB最適化）
    batch_size: 128               # 安定性重視
    num_epochs: 50                # NEIMS v2.0仕様
    num_workers: 8                # Ryzen 7700: 8コア
    prefetch_factor: 4
    gradient_accumulation_steps: 1
    learning_rate: 1.0e-4         # AdamW推奨値
    weight_decay: 1.0e-5

    # Optimizer & Scheduler
    optimizer: "AdamW"
    scheduler: "CosineAnnealingWarmRestarts"
    scheduler_t0: 10
    scheduler_tmult: 2

    # 正則化
    gradient_clip: 1.0
    dropout: 0.3

    # 混合精度訓練
    use_amp: true

    # 保存設定
    checkpoint_dir: "checkpoints/teacher"
    save_interval: 10

    # データサブセット（デバッグ用）
    use_subset: null              # 例: 10000

    # ロギング
    use_wandb: false
    wandb_project: "neims-v2-teacher-pretrain"

    # Bond Masking設定
    bond_masking:
      mask_ratio: 0.15            # 15%のbondをマスク
      lambda_bond: 0.1            # Bond masking loss weight

  # Phase 2: Teacherファインチューニング（NIST EI-MS）
  teacher_finetune:
    # 事前学習済みモデル
    pretrained_checkpoint: "checkpoints/teacher/pretrained_teacher.pt"

    # データセット
    dataset: "NIST_EIMS"

    # 訓練設定（RTX 5070 Ti 16GB最適化）
    batch_size: 32                # MC Dropout用に小さめ
    num_epochs: 100               # NEIMS v2.0仕様
    num_workers: 8
    prefetch_factor: 4
    persistent_workers: true
    gradient_accumulation_steps: 1
    learning_rate: 1.0e-4
    weight_decay: 1.0e-5

    # Optimizer & Scheduler
    optimizer: "AdamW"
    scheduler: "CosineAnnealingWarmRestarts"
    scheduler_t0: 10
    scheduler_tmult: 2

    # 正則化
    gradient_clip: 1.0
    dropout: 0.3

    # MC Dropout設定
    mc_dropout:
      enabled: true
      n_samples: 30               # Uncertainty estimation
      dropout_rate: 0.3

    # 混合精度訓練
    use_amp: true

    # 損失関数
    loss_function:
      type: "MSE"
      lambda_spectrum: 1.0
      lambda_bond: 0.0            # Finetuning時はBond Maskingなし

    # 保存設定
    checkpoint_dir: "checkpoints/teacher"
    save_interval: 5

    # Early Stopping
    early_stopping:
      patience: 20
      min_delta: 0.0001

    # ロギング
    use_wandb: false
    wandb_project: "neims-v2-teacher-finetune"

    # データ拡張
    augmentation:
      lds:
        enabled: true
        sigma: 1.5                # m/z units
      isotope:
        enabled: true
        probability: 0.05
      conformer:
        enabled: false            # Finetuning時は無効

# GPU設定（RTX 5070 Ti 16GB最適化）
gpu:
  use_cuda: true
  device_ids: [0]
  mixed_precision: true
  compile: false                # PyTorch Geometricとの相性問題
  compile_mode: "default"

  # メモリ最適化
  memory_optimization:
    gradient_accumulation_steps: 1
    empty_cache_interval: 100
    pin_memory: true

  # RTX 50シリーズ固有の設定
  rtx50:
    enable_compat: true
    force_sm90_emulation: false

# CPU設定（Ryzen 7700最適化）
cpu:
  num_cores: 8
  num_threads: 16
  memory_limit_gb: 32

# ロギング設定
logging:
  use_tensorboard: true
  use_wandb: false
  log_dir: "logs/neims_v2_teacher"
  log_every: 10

# 評価設定
evaluation:
  metrics:
    - "recall_at_k"
    - "spectral_similarity"
    - "mse"
    - "mae"
    - "rmse"
  recall_k_values: [5, 10, 20]
  recall_target: 0.955          # 目標: Recall@10 ≥ 95.5%

  # 効率性メトリクス
  measure_inference_time: true
  measure_memory_usage: true

  # MC Dropout専用
  mc_dropout_metrics:
    uncertainty_calibration: true
    epistemic_uncertainty: true

# ハードウェア仕様（参考情報）
hardware:
  cpu:
    model: "AMD Ryzen 7700"
    cores: 8
    threads: 16
  gpu:
    model: "NVIDIA RTX 5070 Ti"
    vram_gb: 16
    architecture: "Blackwell (sm_120)"
  memory:
    ram_gb: 32
    type: "DDR4/DDR5"
  storage:
    capacity_gb: 1000
    type: "SSD"
